#
# tag           : tag_aroai_supply_vs_demand_level
# Called by     : aroai_evaluate_production_building aroai_evaluate_building_railway + many more evaluate function
# Usage         : market.mg:transportation.aroai_supply_vs_demand_level >= 9
# How supplied a market is with a good. Lower levels means undersupply.
# Using default price formula to illustrate:
# Level 1 is shortage >75%
# Levels 2-11 go from +75% to 0%
# Levels 12-21 go from 0% to -75%
# Level 22 is excess <-75%
#
aroai_supply_vs_demand_level = {
    if = {
        limit = {
            market_goods_buy_orders <= 0
        }
        value = 99
    }
    else = {
        if = {
            limit = {
                market_goods_sell_orders <= 0
            }
            value = 1
        }
        else = {
            value = 22
            subtract = {
                if = {
                    limit = {
                        market_goods_buy_orders > market_goods_sell_orders
                    }
                    value = market_goods_buy_orders
                    divide = market_goods_sell_orders
                    divide = {
                        value = define:NEconomy|BUY_SELL_DIFF_AT_MAX_FACTOR
                        subtract = 1
                        min = 1
                    }
                    multiply = 10
                    ceiling = yes
                    min = 11
                    max = 21
                }
                else = {
                    value = 20
                    subtract = {
                        value = market_goods_sell_orders
                        divide = market_goods_buy_orders
                        divide = {
                            value = define:NEconomy|BUY_SELL_DIFF_AT_MAX_FACTOR
                            subtract = 1
                            min = 1
                        }
                        multiply = 10
                        floor = yes
                        min = 10
                        max = 20
                    }
                }
            }
        }
    }
}



# When military forces are being used, we limit construction of military buildings case demand is higher than usual
aroai_max_level_when_using_military_forces = 6

# ----------------------------------------------
# General info about government building targets
# ----------------------------------------------

# THIS IS NOT ENTIRELY CORRECT ANYMORE I'll remove it when I entirely reworked budgeting

# Government buildings don't produce goods in most cases, so you can't judge them by productivity or whatever, you need
# to establish some special measure of how important are they and how much of them a country needs. To solve this two
# values are introduced for each government building, share and target.

# Share is % of budget income of a country that it can spend on this building weekly to pay for wages and input good.
# Usually it's pretty rigid, roughly set to what works the best, but with some dynamic factors added in more cases.
# For example, government administration share is higher when tax capacity is low country-wide. Construction sector
# is special in a sense that it has no base or fixed share, instead it just takes all what's left after other shares.
# Please note that for AI shares are always calculated for normal tax and wage level, otherwise it would be unstable.
# Again consruction sector are special here, they always assume high tax level at the beginning for faster development
# of economy, but when a country won't have much free workforce left, sector will demand less and less money, down to
# normal tax level and even a bit below it.

# Target is arbitrary value on how much stuff a country wants to have, be it spare bureaucracy, innovation, battalions,
# convoys, everything. Except construction sectors, of course. They have no target. Anyways, targets are calculated by
# some random ass formulas, most of the time in some form of population multiplied by some form of GDP per capita, with
# a bunch of other factors thrown in. If country is below target, but expenses already exceed share, it won't construct
# more in most cases, so share acts as a limiter. If country reached target but not share, it may build some more of
# this building cause why not if they are rich enough for that.

# --------------------------------------------------------------
# Various common factors that affect government building targets
# --------------------------------------------------------------

# If a country is forced to spend most of its money on government administrations, we need to lower other shares
# Called : building, port, university share
# Range : [0.25, 1]
aroai_target_multiplier_with_high_government_spending = {
    value = 1
    subtract = {
        value = {
            value = aroai_building_government_administration_spending_value
            divide = aroai_country_active_income
        }
        divide = {
            value = aroai_building_government_administration_spending_share
            multiply = 1.20
        }
        subtract = 1
        min = 0
        max = 0.75
    }
}


# If construction is largely sponsored by investment pool, we want to raise non-construction shares
# Range : [1, 2.2]
aroai_target_multiplier_with_investment_pool = {
    value = 1.00
    add = {
        value = 1.20
        multiply = {
            value = aroai_investment_pool_expected
            divide = aroai_country_active_income
            divide = 0.30
            min = 0
            max = 1
        }
    }
}


# ----------------------------------------------
# General info about budget management
# ----------------------------------------------

# Government buildings do not typically produce goods, so it is not possible to judge their productivity. Instead, it is
# necessary to establish a special measure of their importance and the quantity needed by a country.

# When it comes to ports, the goal is to have enough to facilitate the growth of trade routes, as it is a self-sustaining
# investment. Having more ports than necessary would be a waste of money. However, we never downsize them as they're
# usually insignificant spending.

# University and bureaucracy have a special system, I won't describe them as they'll probably be reworked at some point.

# This leaves us with the military and construction sectors. A country can be in one of two states: industrialized or
# industrializing. In order to employ its citizens as quickly as possible, a country is considered industrialized if it
# can provide employment for almost all of its unemployed citizens by the end of the year. We calculate the number of
# construction points required for this based on aroai_max_wanted_constructions_points_from_pop. If a country cannot
# afford that many construction points, it is still in the process of industrializing.

# If the country is still in the industrializing phase, we calculate the amount of money that can be allocated to the
# military and construction sectors using aroai_revenue_left_for_construction_military. In an ideal scenario, 25% of
# this amount would be allocated to the military, while 75% would go to the construction sector. However, there are two
# factors to consider: 1) the budget's instability and 2) the rigid nature of military spending, as aroai does not have
# control over the production methods. We aim to minimize downsizing as much as possible since we cannot remove individual
# levels of buildings; we can only delete entire buildings. Furthermore, we can easily regulate the amount of money
# allocated to construction by reducing the number of construction points available.
# (Please note that buildings cannot be removed from the construction queue.)

# A separate system will try to align the actual military spending with the target of 25% of
# aroai_revenue_left_for_construction_military. This system will undergo revisions at some point. The remaining funds,
# aroai_revenue_left_for_construction, will be available for the construction sector.

# If the country is already industrialized, we know the exact number of construction points needed:
# aroai_max_wanted_constructions_points_from_pop. We allocate this amount of money to the construction sector and
# allocate the remaining funds to the military sector.



aroai_military_spending_share = {
    if = {
        # If construction spending is capped, this means that now military spending is uncapped
        limit = {
            aroai_construction_share_developed < aroai_construction_share_developing
        }
        value = aroai_military_share_developed
    }
    else = {
        value = aroai_military_share_developing
    }
    multiply = aroai_revenue_left_for_construction_military
    divide = income
}

# gold reserve in weeks of income
aroai_gold_reserve_scaled = {
    value = gold_reserves
    divide = income
    min = 0

}

# [0.7, INF], = 1 when you have 20 x income in gold reserve
aroai_gold_reserve_scaled_factor = {
    value = aroai_gold_reserve_scaled
    multiply = 0.3 # without this, factor would be 1.7 at x week

    divide = 10
    add = 0.7
}

# [0, 0.7], = 0 at half of allowed credit
aroai_debt_scaled_factor = {
    value = 0.5
    subtract = scaled_debt
    min = 0
    multiply = 2    # to get a [0, 1] range
    multiply = 0.7  # to get a [0, 0.7] range
}

# We take the max value between the two
# The purpose of this  functions is to keep budget balanced.
# Sometimes, the ai will spend more than they should on military this leads to less gold reserve, so smaller factor so smaller expense.
# Sometimes, the ai will spend less than allocated on military. This leads to bigger gold reserve, money that should be spend. The factor will then artificially raise the budget for construction and military.
# The balance is X weeks of revenue for the gold reserve.
aroai_revenue_factor_construction_military = {
    value = {
        if = {
            limit = {
                aroai_debt_scaled_factor < 0.7
            }
            value = aroai_debt_scaled_factor
        }
        else = {
             value = aroai_gold_reserve_scaled_factor
        }
    }
}


# Effective construction share of income
# Min : 1 - sum of every other theoretical share
aroai_revenue_left_for_construction_military = {
    value = income

    subtract = {
        value = investment_pool_gross_income
        subtract = investment_pool_net_income
    }

    if = {
        limit = { is_subject_type = subject_type_puppet}
        multiply = 0.7
    }
    else_if = {
        limit = { is_subject_type =  subject_type_dominion }
        multiply = 0.75
    }
    else_if = {
        limit = { is_subject_type =  subject_type_vassal }
        multiply = 0.75
    }
    else_if = {
        limit = { is_subject_type =  subject_type_tributary }
        multiply = 0.8
    }

    subtract = {
        value = aroai_building_government_administration_spending_value
        add = aroai_building_university_spending_value
        add = aroai_building_port_spending_value
        add = aroai_building_research_institute_spending
        add = var:aroai_total_subsidies
    }

    multiply = aroai_revenue_factor_construction_military
}

aroai_construction_sector_spending_share = {
   value = {
        # If construction spending is capped, this means that now military spending is uncapped
        if = {
            limit = {
                aroai_construction_share_developed < aroai_construction_share_developing # = 0.75
            }
            value = aroai_construction_share_developed
        }
        else = {
            value = aroai_construction_share_developing
        }
    }
    multiply = aroai_revenue_left_for_construction_military
    multiply = aroai_revenue_factor_construction_military
    divide = income
}

aroai_construction_sector_spending_value_target = {
    value = aroai_construction_sector_spending_share
    multiply = income
}

aroai_max_wanted_constructions_points_from_budget = {
    value = aroai_construction_sector_spending_value_target
    divide = aroai_building_construction_sector_expenses_per_point
}




#
# tag           : tag_aroai_building_construction_sector_spending_value
# Called by     : aroai_calculate_budget_surplus aroai_building_construction_sector_spending_expected
# Effective Construction Spending
# Does NOT assume that we pay for every construction point
#
aroai_building_construction_sector_spending_value = {
    if = {
        limit = {
            has_variable = aroai_previous_building_construction_sector_expenses
        }
        value = var:aroai_previous_building_construction_sector_expenses
    }
    else = {
        value = 0
    }
    min = 0
    max = 1000000000 #billion
}

aroai_building_construction_sector_spending_expected = {
    value = aroai_building_construction_sector_spending_value
    add = {
        if = {
            limit = {
                aroai_building_construction_sector_spending_value > 0
                has_variable = aroai_building_construction_sector_total
                var:aroai_building_construction_sector_total > 0
            }
            value = aroai_building_construction_sector_spending_value
            divide = var:aroai_building_construction_sector_total
        }
        else = {
            value = 2000
        }
        multiply = aroai_construction_limit_5_6
    }
}